#!/usr/bin/env ruby

require_relative "../../lib/paradox_game"
require "json"

class ImportData < ParadoxGame
  def initialize(*roots)
    super(*roots)
  end

  def each_unit
    glob("common/units/*.txt").each do |path|
      parse(path)["sub_units"].each do |name, unit|
        yield(name, unit)
      end
    end
  end

  def call
    data = { units: {}}
    each_unit do |name, unit|
      raise "Duplicate name: #{name}" if data[:units][name]
      bonuses = {}
      unit_data = {}
      unit.each do |key, value|
        case key
        when "combat_width", "max_strength", "max_organisation",
          "default_morale", "manpower", "training_time",
          "suppression", "weight", "supply_consumption",
          "maximum_speed"
          unit_data[key] = value
        when "need"
          unit_data["need"] = value.to_h
        when "forest", "marsh", "hills", "urban", "mountain",
             "jungle", "amphibious", "river", "fort", "plains",
             "desert"
          bonuses[key] = value.to_h
        when "priority", "ai_priority", "sprite", "map_icon_category"
        else
          warn "Unknown key #{key}"
        end
      end

      unit_data["bonuses"] = bonuses
      data[:units][name] = unit_data
    end

    puts JSON.pretty_generate(data)
  end
end

ImportData.new(*ARGV).call
