#!/usr/bin/env ruby

require "pry"
require_relative "../lib/paradox_game"

# Assumes 50% MP bonus
class Unit
  def initialize(cav, has_mp)
    @cav = cav
    @has_mp = has_mp
  end

  def suppression
    if @has_mp
      @cav * 3.0
    else
      @cav * 2.0
    end
  end

  def name
    if @has_mp
      "#{@cav}cav+mp"
    else
      "#{@cav}cav"
    end
  end

  def manpower
    @cav * 1000 + (@has_mp ? 500 : 0)
  end

  def ic
    @cav * 60 + (@has_mp ? 60 : 0)
  end
end

class AnalyzeVictoryPoints < ParadoxGame
  def states
    unless @states
      @states = {}
      glob("history/states/*.txt").each do |path|
        node = parse(path)["state"]
        id = node["id"]
        name = localization(node["name"])
        vps = node["history"]["victory_points"] || []
        total = vps.each_slice(2).map(&:last).inject(0, &:+)
        raise unless total = total.to_i
        total = total.to_i
        # Some names are duplicates
        raise if @states[id]
        @states[id] = {name: name, total: total}
      end
    end
    @states
  end

  def state_count_by_vp_total
    unless @state_count_by_vp_total
      @state_count_by_vp_total = Hash.new(0)
      states.each do |id, state|
        @state_count_by_vp_total[state[:total]] += 1
      end
    end
    @state_count_by_vp_total
  end

  def total_suppression_needed(mod, units)
    total = Hash.new(0)
    state_count_by_vp_total.each do |vp_total, count|
      resistance = (vp_total * mod).floor
      units.each do |unit|
        while (resistance >= unit.suppression) or (resistance > 0 and unit.suppression <= 2)
          total[unit.name] += count
          total["ic"] += unit.ic * count
          total["men"] += unit.manpower * count
          resistance -= unit.suppression
        end
      end
      raise if resistance > 0
    end
    total
  end

  def report!
    units = {
      "1cav"    => Unit.new(1, false),
      "1cav+mp" => Unit.new(1, true),
      "2cav+mp" => Unit.new(2, true),
      "3cav+mp" => Unit.new(3, true),
      "4cav+mp" => Unit.new(4, true),
      "5cav+mp" => Unit.new(5, true),
      "6cav+mp" => Unit.new(6, true),
      "7cav+mp" => Unit.new(7, true),
      "8cav+mp" => Unit.new(8, true),
      "9cav+mp" => Unit.new(9, true),
      "10cav+mp" => Unit.new(10, true),
    }
    levels = {
      "harshest" => 1.0,
      "harsh" => 0.8,
      "gentle" => 0.6,
      "gentlest" => 0.4,
    }
    levels.each do |level, mod|
      puts "To suppress the whole world at #{level} treatment you need:"
      units.each do |name, unit|
        needed = total_suppression_needed(mod, [unit, Unit.new(1, false)])
        puts "* #{name} - #{needed.inspect}"
      end
      puts ""
    end
  end
end

if __FILE__ == $0
  AnalyzeVictoryPoints.new(*ARGV).report!
end
