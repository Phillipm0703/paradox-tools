#!/usr/bin/env ruby

require "pry"
require_relative "../lib/paradox_game"
require "json"

class CountryInformation
  attr_reader :divisions, :manpower, :ships, :equipment, :ic, :resources
  attr_accessor :faction
  def initialize(ledger, tag, country)
    @ledger = ledger
    @tag = tag
    @original_tag = country["original_tag"] || @tag
    @resources = Hash.new(0)
    @ic = Hash.new(0)
    @divisions = 0
    @manpower = Hash.new(0)
    @ships = Hash.new(0)
    @equipment = {}
    @faction = "Neutrals"
    @ideology = country["politics"]["ruling_party"]
    @name = ledger.localization("#{@original_tag}_#{@ideology}")

    country["resources"]["produced"].each do |name, amount|
      raise unless amount == amount.to_i
      @resources[name] = amount.to_i
    end
    add_equipments! country["production"]["equipments"]
    add_units! country["units"]
    add_deployment! country["deployment"]
  end

  def add_deployment!(deployment)
    return unless deployment
    deployment.each do |type, data|
      next unless type == "military_deployment_conveyor"
      data.find_all("military_deployment_line").each do |line|
        add_unit_in_training! line["military_deployment"]
      end
    end
  end

  def add_unit_in_training!(unit)
    @manpower["training"] += unit["manpower"] if unit["manpower"]
    add_equipments! unit["equipment"] if unit["equipment"]
  end

  def add_units!(units)
    return unless units
    units.each do |type, unit|
      # unit["logical_country"] # For expeditionary corps/volunteers/etc. presumably?
      case type
      when "division"
        add_division! unit
      when "navy"
        add_navy! unit
      else
        binding.pry
      end
    end
  end

  def add_owned_state!(state)
    return unless state["buildings"]
    ["dockyard", "industrial_complex", "arms_factory"].each do |type|
      next unless state["buildings"][type]
      next if state["buildings"][type] == []
      count = state["buildings"][type]["level"].size
      @ic["owned_#{type}"] += count
      @ic["owned_total"] += count
    end
  end

  def add_controlled_state!(state)
    return unless state["buildings"]
    ["dockyard", "industrial_complex", "arms_factory"].each do |type|
      next unless state["buildings"][type]
      next if state["buildings"][type] == []
      count = state["buildings"][type]["level"].size
      count_working = state["buildings"][type]["level"].select{|lvl| lvl == 100}.size
      @ic["controlled_#{type}"] += count
      @ic["controlled_total"] += count
      @ic["working_#{type}"] += count_working
      @ic["working_total"] += count_working
    end
  end

  def add_navy!(unit)
    @manpower["navy"] += unit["manpower"]
    unit.find_all("ship").each do |ship|
      @ships[ship["definition"]] += 1
      @ships["total"] += 1
    end
  end

  def add_division!(unit)
    @manpower["army"] += unit["manpower"]
    @divisions += 1
    add_equipments! unit["equipment"]
  end

  def add_equipments!(equipments)
    equipments.each do |cat, equipment|
      binding.pry unless cat == "equipment"
      add_equipment! equipment
    end
  end

  def add_equipment!(equipment)
    archetype, level = @ledger.equipment[equipment["id"]]
    amount = equipment["amount"]
    amount = amount.to_i if amount == amount.to_i

    @equipment[archetype] ||= Hash.new(0)
    @equipment[archetype][level] += amount
    @equipment[archetype]["total"] += amount
  end

  def add_air_force!(air_force)
    air_force.find_all("air_wing_pool").each do |air_wing_pool|
      air_wing_pool.find_all("air_wings").each do |air_wing|
        @manpower["air"] += air_wing["manpower"]
        add_equipments! air_wing["equipment"]
      end
    end
  end

  def summarize_equipment_table
    Hash[
      @equipment.map do |archetype, details|
        total = details["total"]
        max_level = (details.keys - ["total"]).max
        counts_by_level = (0..max_level).map{|i| details[i]}
        summarized_details = "#{total} (#{counts_by_level.join(' ')})"
        [@ledger.localization(archetype), summarized_details]
      end.sort
    ]
  end

  def to_json
    {
      name: @name,
      ideology: @ideology,
      faction: @faction,
      resources: Hash[@resources.sort],
      ic: Hash[@ic.sort],
      divisions: @divisions,
      manpower:  Hash[@manpower.sort],
      ships:  Hash[@ships.sort],
      equipment: summarize_equipment_table,
    }
  end
end

class FactionInformation
  def initialize(ledger, name)
    @ledger = ledger
    @name = name
    @countries = []
    @resources = Hash.new(0)
    @ic = Hash.new(0)
    @divisions = 0
    @manpower = Hash.new(0)
    @ships = Hash.new(0)
    @equipment = {}
  end

  def add_country!(country)
    @divisions += country.divisions
    country.manpower.each do |cat, count|
      @manpower[cat] += count
    end
    country.resources.each do |cat, count|
      @resources[cat] += count
    end
    country.ic.each do |cat, count|
      @ic[cat] += count
    end
    country.ships.each do |cat, count|
      @ships[cat] += count
    end
    country.equipment.each do |archetype, details|
      @equipment[archetype] ||= Hash.new(0)
      details.each do |level, count|
        @equipment[archetype][level] += count
      end
    end
  end

  def summarize_equipment_table
    Hash[
      @equipment.map do |archetype, details|
        total = details["total"]
        max_level = (details.keys - ["total"]).max
        counts_by_level = (0..max_level).map{|i| details[i]}
        summarized_details = "#{total} (#{counts_by_level.join(' ')})"
        [@ledger.localization(archetype), summarized_details]
      end.sort
    ]
  end

  def to_json
    {
      name: @name,
      resources: Hash[@resources.sort],
      ic: Hash[@ic.sort],
      divisions: @divisions,
      manpower:  Hash[@manpower.sort],
      ships: Hash[@ships.sort],
      equipment: summarize_equipment_table,
    }
  end
end

class GenerateLedger < ParadoxGame
  attr_reader :equipment
  def initialize(save_path, *roots)
    @save_path = Pathname(save_path)
    super(*roots)
    @data = ParadoxModFile.new(path: save_path).parse!
  end

  def date
    @data["date"]
  end

  def save_report!(path, data)
    Pathname(path).parent.mkpath
    Pathname(path).write(JSON.pretty_generate(data) + "\n")
  end

  def setup_equipment_mapping!
    @equipment = {}
    @archetype = {}
    levels = Hash.new(0)
    glob("common/units/equipment/*.txt").each do |path|
      parse(path)["equipments"].each do |name, equipment|
        next if equipment["is_archetype"]
        a = equipment["archetype"]
        @archetype[name] = [a, levels[a]]
        levels[a] += 1
      end
    end
    @data["equipments"].each do |type, equipment|
      binding.pry if @equipment[equipment["id"]]
      raise unless @archetype[type]
      @equipment[equipment["id"]] = @archetype[type]
    end
  end

  def analyze_country_information!
    @countries = {}
    @data["countries"].each do |tag, country|
      @countries[tag] ||= CountryInformation.new(self, tag, country)
    end
    @data["states"].each do |num, state|
      owner = state["owner"]
      controller = state["controller"] || owner
      @countries[owner].add_owned_state! state
      @countries[controller].add_controlled_state! state
    end
    @data["strategic_air"].each do |tag, air_force|
      next if tag == "air_base"
      @countries[tag].add_air_force! air_force
    end
  end

  def save_reports!
    system "trash", "ledger" if Pathname("ledger").exist?
    @countries.each do |tag, country|
      save_report! "ledger/country/#{tag}.json", country.to_json
    end
    @factions.each do |name, faction|
      save_report! "ledger/factions/#{name}.json", faction.to_json
    end
  end

  def analyze_faction_information!
    @factions = {}
    @data.find_all("faction").each do |faction|
      name = faction["name"]
      faction["members"].each do |tag|
        @countries[tag].faction = name
      end
    end
    @countries.each do |tag, country|
      faction_name = country.faction
      @factions[faction_name] ||= FactionInformation.new(self, faction_name)
      @factions[faction_name].add_country! country
    end
  end

  def run!
    setup_equipment_mapping!
    analyze_country_information!
    analyze_faction_information!
    save_reports!
  end

  def inspect
    "Ledger<#{@save_path}>"
  end
end


unless ARGV.size >= 2
  STDERR.puts "Usage: #{$0} <save.hoi4> <hoi4_path> [<mod1_path> <mod2_path> ...]"
  STDERR.puts "# non-binary saves only"
  exit 1
end

GenerateLedger.new(*ARGV).run!
